<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ABRØNIX | CLOUD SYNCED</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #ff0033;
            --bg-body: #050505;
            --bg-card: #0f0f0f;
            --text-main: #ffffff;
            --text-muted: #888;
            --border: #222;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg-body); color: var(--text-main); font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }

        /* MOBILE RESPONSIVE SIDEBAR */
        .sidebar { width: 70px; background: var(--bg-card); border-right: 1px solid var(--border); display: flex; flex-direction: column; align-items: center; padding: 20px 0; z-index: 100; }
        .logo { color: var(--primary); font-size: 1.5rem; margin-bottom: 30px; }
        .nav-item { padding: 20px; color: var(--text-muted); cursor: pointer; transition: 0.2s; font-size: 1.2rem; }
        .nav-item.active { color: var(--primary); border-left: 3px solid var(--primary); background: rgba(255,0,51,0.1); }

        .main { flex: 1; display: flex; flex-direction: column; }
        .top-bar { height: 60px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; background: #111; }
        .cloud-status { font-size: 0.8rem; display: flex; align-items: center; gap: 5px; color: #666; }
        .cloud-status.active { color: #00ff41; }

        .content { flex: 1; padding: 20px; overflow-y: auto; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from {opacity:0} to {opacity:1} }

        h1 { font-size: 1.8rem; margin: 0 0 20px 0; text-transform: uppercase; }
        h1 span { color: var(--primary); }

        .card { background: var(--bg-card); border: 1px solid var(--border); padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }

        input { width: 100%; background: #000; border: 1px solid #333; padding: 12px; color: white; border-radius: 4px; margin-bottom: 15px; }
        input:focus { border-color: var(--primary); }
        label { display: block; color: #666; font-size: 0.8rem; margin-bottom: 5px; }

        .btn { background: var(--primary); color: white; border: none; padding: 12px; width: 100%; font-weight: bold; border-radius: 4px; cursor: pointer; }
        .btn:hover { background: #cc0029; }

        .chat-box { height: 400px; display: flex; flex-direction: column; background: #000; border: 1px solid #333; border-radius: 8px; }
        .msgs { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 10px; border-radius: 6px; max-width: 85%; font-size: 0.9rem; line-height: 1.4; }
        .msg.ai { background: #1a1a1a; border-left: 2px solid var(--primary); align-self: flex-start; }
        .msg.user { background: var(--primary); align-self: flex-end; }
    </style>
</head>
<body>

    <nav class="sidebar">
        <div class="logo"><i class="fa-solid fa-crosshairs"></i></div>
        <div class="nav-item active" onclick="nav('dashboard')"><i class="fa-solid fa-chart-line"></i></div>
        <div class="nav-item" onclick="nav('coach')"><i class="fa-solid fa-robot"></i></div>
        <div class="nav-item" onclick="nav('settings')"><i class="fa-solid fa-gear"></i></div>
    </nav>

    <main class="main">
        <div class="top-bar">
            <span style="font-weight:bold;">ABRØNIX <span style="color:var(--primary)">OS</span></span>
            <div class="cloud-status" id="cloud-indicator"><i class="fa-solid fa-circle"></i> <span id="cloud-text">LOCAL</span></div>
        </div>

        <div class="content">
            <!-- DASHBOARD -->
            <div id="dashboard" class="page active">
                <h1>Live <span id="dash-user">Stats</span></h1>
                <div class="grid">
                    <div class="card">
                        <label>K/D RATIO</label>
                        <div style="font-size:2rem; font-weight:bold;" id="stat-kd">--</div>
                    </div>
                    <div class="card">
                        <label>WIN RATE</label>
                        <div style="font-size:2rem; font-weight:bold;" id="stat-win">--</div>
                    </div>
                </div>
                <div class="card">
                    <label>PERFORMANCE TREND</label>
                    <canvas id="chart" height="100"></canvas>
                </div>
                <button class="btn" onclick="syncAll()">FORCE CLOUD SYNC <i class="fa-solid fa-cloud-arrow-up"></i></button>
            </div>

            <!-- COACH -->
            <div id="coach" class="page">
                <h1>AI <span style="color:#4285F4">Coach</span></h1>
                <div class="chat-box">
                    <div class="msgs" id="chat-msgs">
                        <div class="msg ai">ABRØNIX Neural Cloud connected. I remember your past sessions. How can we improve today?</div>
                    </div>
                    <div style="padding:15px; border-top:1px solid #333; display:flex; gap:10px;">
                        <input type="text" id="ai-input" placeholder="Ask about rotations..." style="margin:0;">
                        <button class="btn" style="width:auto;" onclick="sendAI()"><i class="fa-solid fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>

            <!-- SETTINGS -->
            <div id="settings" class="page">
                <h1>Cloud <span style="color:var(--primary)">Setup</span></h1>
                <p style="color:#888; font-size:0.9rem;">To sync across devices, paste your keys below on EVERY device.</p>
                
                <div class="card">
                    <label>Fortnite Username</label>
                    <input type="text" id="cfg-user">
                    
                    <label>FortniteAPI.io Key (Stats)</label>
                    <input type="password" id="cfg-fn">

                    <label>Gemini AI Key</label>
                    <input type="password" id="cfg-ai">
                    
                    <label style="color:#00ff41;">Firebase Database URL (For Sync)</label>
                    <input type="text" id="cfg-db" placeholder="https://your-project.firebaseio.com/">
                    
                    <button class="btn" onclick="saveConfig()">SAVE & CONNECT</button>
                </div>
            </div>
        </div>
    </main>

    <script>
        // --- DATA MANAGEMENT ---
        const CONFIG = {
            user: localStorage.getItem('abx_user') || '',
            fn: localStorage.getItem('abx_fn') || '',
            ai: localStorage.getItem('abx_ai') || '',
            db: localStorage.getItem('abx_db') || ''
        };

        window.onload = () => {
            // Fill Inputs
            document.getElementById('cfg-user').value = CONFIG.user;
            document.getElementById('cfg-fn').value = CONFIG.fn;
            document.getElementById('cfg-ai').value = CONFIG.ai;
            document.getElementById('cfg-db').value = CONFIG.db;

            if(CONFIG.user) document.getElementById('dash-user').innerText = CONFIG.user.toUpperCase();
            
            // Try to load from cloud if DB exists, otherwise load stats
            if(CONFIG.db && CONFIG.user) {
                loadFromCloud();
            } else if(CONFIG.user && CONFIG.fn) {
                fetchStats();
            }
        };

        function saveConfig() {
            localStorage.setItem('abx_user', document.getElementById('cfg-user').value);
            localStorage.setItem('abx_fn', document.getElementById('cfg-fn').value);
            localStorage.setItem('abx_ai', document.getElementById('cfg-ai').value);
            localStorage.setItem('abx_db', document.getElementById('cfg-db').value);
            alert("Settings Saved! reloading...");
            location.reload();
        }

        // --- CLOUD SYNC ENGINE (FIREBASE REST) ---
        async function loadFromCloud() {
            updateStatus('SYNCING...', '#ffa500');
            try {
                // We use the Username as the ID. Clean it to be URL safe.
                const safeUser = CONFIG.user.replace(/[^a-zA-Z0-9]/g, '_');
                const url = `${CONFIG.db}/users/${safeUser}.json`;

                const res = await fetch(url);
                const data = await res.json();

                if(data) {
                    // Restore Chat History
                    if(data.chatHistory) {
                        document.getElementById('chat-msgs').innerHTML = data.chatHistory;
                    }
                    console.log("Cloud Data Loaded");
                }
                updateStatus('CLOUD CONNECTED', '#00ff41');
                fetchStats(); // Refresh fresh stats
            } catch(e) {
                console.error(e);
                updateStatus('CLOUD ERROR', 'red');
            }
        }

        async function syncAll() {
            if(!CONFIG.db || !CONFIG.user) return alert("Missing Database URL or Username in settings");
            
            const safeUser = CONFIG.user.replace(/[^a-zA-Z0-9]/g, '_');
            const url = `${CONFIG.db}/users/${safeUser}.json`;
            
            // What to save
            const payload = {
                lastUpdate: new Date().toISOString(),
                chatHistory: document.getElementById('chat-msgs').innerHTML,
                stats: {
                    kd: document.getElementById('stat-kd').innerText
                }
            };

            updateStatus('UPLOADING...', '#ffa500');
            
            await fetch(url, {
                method: 'PUT', // PUT replaces data at this path
                body: JSON.stringify(payload)
            });

            updateStatus('SYNCED', '#00ff41');
        }

        function updateStatus(text, color) {
            document.getElementById('cloud-text').innerText = text;
            document.getElementById('cloud-indicator').style.color = color;
        }

        // --- FORTNITE STATS ---
        async function fetchStats() {
            if(!CONFIG.fn || !CONFIG.user) return;
            
            try {
                const lookup = await fetch(`https://fortniteapi.io/v1/lookup?username=${CONFIG.user}`, { headers: {'Authorization': CONFIG.fn}});
                const user = await lookup.json();
                
                if(user.result) {
                    const stats = await fetch(`https://fortniteapi.io/v1/stats?account=${user.account_id}`, { headers: {'Authorization': CONFIG.fn}});
                    const data = await stats.json();
                    
                    if(data.global_stats) {
                        const s = data.global_stats.solo;
                        document.getElementById('stat-kd').innerText = s.kd.toFixed(2);
                        document.getElementById('stat-win').innerText = (s.winrate*100).toFixed(1) + '%';
                        renderChart(s.kd);
                        
                        // Auto sync stats to cloud after fetching
                        if(CONFIG.db) setTimeout(syncAll, 2000); 
                    }
                }
            } catch(e) { console.log("Stats Error", e); }
        }

        function renderChart(kd) {
            new Chart(document.getElementById('chart'), {
                type: 'line',
                data: {
                    labels: ['1', '2', '3', 'Now'],
                    datasets: [{
                        data: [kd-0.2, kd-0.1, kd+0.1, kd],
                        borderColor: '#ff0033',
                        backgroundColor: 'rgba(255,0,51,0.1)',
                        fill: true,
                        pointRadius: 0
                    }]
                },
                options: { plugins:{legend:{display:false}}, scales:{x:{display:false}, y:{grid:{color:'#222'}}} }
            });
        }

        // --- AI LOGIC ---
        async function sendAI() {
            const input = document.getElementById('ai-input');
            const text = input.value;
            if(!text) return;
            
            const msgs = document.getElementById('chat-msgs');
            msgs.innerHTML += `<div class="msg user">${text}</div>`;
            input.value = '';
            
            if(!CONFIG.ai) {
                msgs.innerHTML += `<div class="msg ai">Please add Gemini Key in Settings.</div>`;
                return;
            }

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${CONFIG.ai}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: "Fortnite Coach (Short/Tactical): " + text }] }] })
                });
                const data = await res.json();
                const reply = data.candidates[0].content.parts[0].text.replace(/\*\*/g, '').replace(/\n/g, '<br>');
                
                msgs.innerHTML += `<div class="msg ai">${reply}</div>`;
                msgs.scrollTop = msgs.scrollHeight;
                
                // Sync chat to cloud
                if(CONFIG.db) syncAll();

            } catch(e) {
                msgs.innerHTML += `<div class="msg ai" style="color:red">AI Error</div>`;
            }
        }

        function nav(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(page).classList.add('active');
            
            const map = {'dashboard':0, 'coach':1, 'settings':2};
            document.querySelectorAll('.nav-item')[map[page]].classList.add('active');
        }
    </script>
</body>
</html>
